<?php	$file = getcwd() . "/" . APPPATH . "controllers/MY_controller.php";			include $file;	class Fsadfzerrwez_zones extends Fsadfzerrwez_home{		function Fsadfzerrwez_zones(){					parent::__construct();				$this->load->model("zone");				$this->load->model('layout');		}				/***********************************************************************/		/**************************** START ZONES *******************************/				/***********************************************************************/				function zones(){			$this->check_login();						$this->check_role(MODULE_ZONES, MODULE_TYPE_VIEW);			$data = $this->get_zones();			$this->load->model('site');			$data['sites'] = $this->site->get_all_sites(get_company_id());			$this->load_page('zones', $this->lang->line('zones'), $data);		}				function ajax_zones(){						$this->check_login_ajax();			$this->check_role_ajax(MODULE_ZONES, MODULE_TYPE_VIEW);			$data = $this->get_zones();			$model['data'] = $data;			$model['controller_name'] = $this->controller_name;			$this->load->view($this->home_directory . "zones-table", $model);		}				private function get_zones(){			$data = $this->get_page_config();				$site_id = $this->input->get('site_id');			$sort_by = $this->input->get('sort_by');			$ascending = $this->input->get('ascending');			$company_id = get_company_id();			$query = $this->zone->get_zones($data['keywords'], $company_id, $site_id, $data['page'], $data['page_size'], $sort_by, $ascending, $num_rows, get_language());			$this->set_paging_data($data, $query, $num_rows);			$data['site_id'] = $site_id;			return $data;		}				function add_zone($id = null){										$this->check_login();			$this->check_role(MODULE_ZONES, MODULE_TYPE_VIEW);			$result = null;			$zone = null;				$err_msg = '';			$company_id = get_company_id();			$data = array();
			$data['back-url'] = get_back_url(base_url("zones"), MODULE_ZONES);			if (is_post()){									$result = false;				$zone = $this->zone->get_post_data();								$this->form_validation->set_rules('zone_name', $this->lang->line('required-zone-name'), 'trim|required');				$this->form_validation->set_rules('site_id', $this->lang->line('required-select-site'), 'trim|required');				if ($this->form_validation->run() == TRUE){					$zone->company_id = $company_id;					//UPDATE CASE						if ($id){						$this->check_role(MODULE_ZONES, MODULE_TYPE_UPDATE);												$result = $this->zone->update($zone, $company_id, $id);						if ($result){							$err_msg = get_saved_message('zone', $zone->zone_name);							if ($this->input->post('save_and_continue') == false){																$this->set_flashdata($err_msg);								redirect($data['back-url']);							}						}							else{							$err_msg = get_saved_fail_message('zone', $zone->zone_name);						}					}					else{						$this->check_role(MODULE_ZONES, MODULE_TYPE_ADD);												$result = $this->zone->insert($zone, get_user_id());												if ($result){								$err_msg = get_saved_message('zone', $zone->zone_name);							if ($this->input->post('save_and_continue') == true){								//clear old data								$zone->clear_data();							}							else{																$this->set_flashdata($err_msg);								redirect($data['back-url']);							}						}						else{							$err_msg = get_saved_fail_message('zone', $zone->zone_name);						}											}				}				else{					$err_msg = $this->lang->line('required-zone');				}			}			else{								if ($id){										$zone = $this->zone->get_id($id);									}				else{										$zone = new zone();				}			}			$this->load->model('site');			$data['sites'] = $this->site->get_all_sites($company_id);			$data['err_msg'] = $err_msg;			$data['result'] = $result;									$data['data'] = $zone;			$data['id'] = $id;						$data['page'] = $this->input->get('page');			$data['page_size'] = $this->input->get('page_size');			$data['keywords'] = $this->input->get('keywords');			$title_page = $this->lang->line('zone');			if (!$zone){				$title_page = get_not_found_short();			}			$this->load_page('add-zone', $title_page, $data);		}				function active_zones(){						$this->check_login_ajax();						$this->check_role_ajax(MODULE_ZONES, MODULE_TYPE_UPDATE);			$active = $this->input->post('active');						$ids = $this->get_array_ids();									$this->zone->active_in(get_company_id(), $active, $ids);		}				function delete_zones(){			$this->check_login_ajax();			$this->check_role_ajax(MODULE_ZONES, MODULE_TYPE_DELETE);			$ids = $this->get_array_ids();			$this->zone->delete_in(get_company_id(), $ids);		}				function layout($zone_id){			$this->check_login();			$this->check_role(MODULE_ZONES, MODULE_TYPE_VIEW);						$data = array();			$this->load->model('device');			$this->load->model('zone');			$company_id = get_company_id();			$data['zone'] = $this->zone->get_id_by_company($zone_id, $company_id);			$data['zones'] = $this->device->get_by_zone($zone_id, $company_id);			$this->zone->get_next_zone($data['zone']->id, $data['zone']->site_id, $company_id, $previous_zone, $next_zone);			$data['previous_zone'] = $previous_zone;			$data['next_zone'] = $next_zone;			$data['devices'] = $this->device->get_by_zone_id($company_id, $zone_id);			$this->load_page('zone-layout', $this->lang->line('zone-layout'), $data);		}				function upload_zone_layout($zone_id){			$this->check_login_ajax();						$this->check_role_ajax(MODULE_ZONES, MODULE_TYPE_UPDATE);			$data = new stdClass();			$data->error = '';			if (is_login()){				$company_id = get_company_id();				$zone = $this->zone->get_id_by_company($zone_id, $company_id);				if ($zone){					$this->load->helper('imaging');					$dir = get_dir_upload_zone($zone_id);					resize_image_upload('file', $dir, 'layout.jpg', 999, 406, true);					$this->zone->update_has_layout($zone_id, $company_id);					$data->url = base_url('uploads/zones/' . $zone_id . '/layout.jpg');				}				else{					$data->error = $this->lang->line('zone-not-found');				}			}			else{				$data->error = $this->lang->line('required-login-upload');			}			echo json_encode($data);					}				function update_device_position(){			$this->check_login_ajax();						$this->check_role_ajax(MODULE_ZONES, MODULE_TYPE_UPDATE);						$zone_id = $this->input->post('zone_id');			$company_id = get_company_id();			$zone = $this->zone->get_id_by_company($zone_id, get_company_id());			if ($zone){				$this->load->model('device');				$device_id = $this->input->post('device_id');				$top = $this->input->post('top');				$left = $this->input->post('left');								$this->device->update_position($device_id, $company_id, $top, $left, get_user_id());			}		}				function update_device_color(){			$this->check_login_ajax();						$this->check_role_ajax(MODULE_ZONES, MODULE_TYPE_UPDATE);						$zone_id = $this->input->post('zone_id');			$zone = $this->zone->get_id_by_company($zone_id, get_company_id());			if ($zone){				$color = $this->input->post('color');				$this->layout->update_color($zone_id, $color);			}		}				function update_disable_alarm_minutes(){			$this->check_login_ajax();			$this->check_role_ajax(MODULE_ZONES, MODULE_TYPE_UPDATE);						$zone_id = $this->input->post('zone_id');			$company_id = get_company_id();			$zone = $this->zone->get_id_by_company($zone_id, $company_id);			if ($zone){				$minutes = $this->input->post('minutes');				$this->zone->update_disable_alarm($zone_id, $company_id, $minutes);			}		}				function enable_alarm(){			$this->check_login_ajax();			$this->check_role_ajax(MODULE_ZONES, MODULE_TYPE_UPDATE);						$zone_id = $this->input->post('zone_id');			$company_id = get_company_id();			$zone = $this->zone->get_id_by_company($zone_id, $company_id);			if ($zone){				$enabled = $this->input->post('enabled');				$this->zone->update_alarm($zone_id, $company_id, $enabled);			}		}				function get_minutes_disabled_remaining(){			$this->check_login_ajax();			$this->check_role_ajax(MODULE_ZONES, MODULE_TYPE_UPDATE);						$zone_id = $this->input->post('zone_id');			$company_id = get_company_id();			$zone = $this->zone->get_id_by_company($zone_id, $company_id);			if ($zone){				echo $zone->minutes_disabled_remaining;			}					}				/***********************************************************************/		/**************************** END OF ZONES *******************************/				/***********************************************************************/			}?>